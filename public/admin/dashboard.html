<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="welcome-panel">
            <div class="welcome-content">
                <div class="logo">
                    <i class="fas fa-user-shield"></i>
                    Admin Dashboard
                </div>
                <h1 class="welcome-title">Welcome, <span id="adminName"></span></h1>
                <div class="admin-info">
                    <p>Administrator</p>
                    <p id="adminEmail"></p>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-panel">
            <div class="dashboard-card">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">Election Management</h2>
                    <button class="btn btn-primary" id="createElectionBtn">
                        <i class="fas fa-plus"></i> Create Election
                    </button>
                </div>
                
                <div class="dashboard-content">
                    <div class="elections-list" id="electionsList">
                        <!-- Elections will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">Candidate Management</h2>
                    <button class="btn btn-primary" id="addCandidateBtn">
                        <i class="fas fa-plus"></i> Add Candidate
                    </button>
                </div>
                
                <div class="dashboard-content">
                    <div class="candidates-list" id="candidatesList">
                        <!-- Candidates will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Election Modal -->
    <div id="electionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalElectionTitle">Create New Election</h2>
            <form id="electionForm">
                <input type="hidden" id="electionId">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="electionTitle" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="electionDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="datetime-local" id="electionStartDate" required>
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="datetime-local" id="electionEndDate" required>
                </div>
                <div class="form-group" id="resultsPublishedContainer" style="display: none;">
                    <label>
                        <input type="checkbox" id="resultsPublished"> Publish Results
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>

    <!-- Candidate Modal -->
    <div id="candidateModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New Candidate</h2>
            <form id="candidateForm">
                <input type="hidden" id="candidateId">
                <div class="form-group">
                    <label>Election</label>
                    <select id="candidateElection" required></select>
                </div>
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="text" id="candidateStudentId" required>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="candidateName" required>
                </div>
                <div class="form-group">
                    <label>Photo URL</label>
                    <input type="text" id="candidatePhotoUrl">
                </div>
                <div class="form-group">
                    <label>Details</label>
                    <textarea id="candidateDetails"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const userRole = sessionStorage.getItem('userRole');
            
            if (!currentUser || userRole !== 'admin') {
                window.location.href = '../index.html';
                return;
            }
            
            document.getElementById('adminName').textContent = currentUser.email;
            document.getElementById('adminEmail').textContent = currentUser.email;
            
            loadElections();
            loadCandidates();
            
            // Election modal setup
            const electionModal = document.getElementById('electionModal');
            const electionBtn = document.getElementById('createElectionBtn');
            const electionSpan = document.querySelector('#electionModal .close');
            
            electionBtn.onclick = function() {
                document.getElementById('modalElectionTitle').textContent = 'Create New Election';
                document.getElementById('electionForm').reset();
                document.getElementById('electionId').value = '';
                document.getElementById('resultsPublishedContainer').style.display = 'none';
                electionModal.style.display = 'block';
            }
            
            electionSpan.onclick = function() {
                electionModal.style.display = 'none';
            }
            
            // Candidate modal setup
            const candidateModal = document.getElementById('candidateModal');
            const candidateBtn = document.getElementById('addCandidateBtn');
            const candidateSpan = document.querySelector('#candidateModal .close');
            
            candidateBtn.onclick = function() {
                document.getElementById('candidateForm').reset();
                document.getElementById('candidateId').value = '';
                loadElectionsForSelect();
                candidateModal.style.display = 'block';
            }
            
            candidateSpan.onclick = function() {
                candidateModal.style.display = 'none';
            }
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                if (event.target == electionModal) {
                    electionModal.style.display = 'none';
                }
                if (event.target == candidateModal) {
                    candidateModal.style.display = 'none';
                }
            }
            
            // Form submissions
            document.getElementById('electionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveElection();
            });
            
            document.getElementById('candidateForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCandidate();
            });
        });
        
        function loadElections() {
            fetch('http://localhost:3002/api/elections')
                .then(response => response.json())
                .then(data => {
                    const electionsList = document.getElementById('electionsList');
                    
                    if (data.data.length === 0) {
                        electionsList.innerHTML = '<p>No elections found. Create one to get started.</p>';
                    } else {
                        electionsList.innerHTML = data.data.map(election => `
                            <div class="election-card">
                                <h3>${election.title}</h3>
                                <p>${election.description || 'No description'}</p>
                                <div class="election-dates">
                                    <span>Starts: ${new Date(election.start_date).toLocaleString()}</span>
                                    <span>Ends: ${new Date(election.end_date).toLocaleString()}</span>
                                    <span>Status: ${new Date(election.start_date) > new Date() ? 'Upcoming' : 
                                          new Date(election.end_date) < new Date() ? 'Ended' : 'Active'}</span>
                                    <span>Results: ${election.results_published ? 'Published' : 'Not Published'}</span>
                                </div>
                                <div class="election-actions">
                                    <button class="btn btn-primary btn-sm" onclick="editElection('${election.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteElection('${election.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    ${new Date(election.end_date) < new Date() && !election.results_published ? 
                                        `<button class="btn btn-success btn-sm" onclick="publishResults('${election.id}')">
                                            <i class="fas fa-chart-bar"></i> Publish Results
                                        </button>` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load elections.');
                });
        }
        
        function loadCandidates() {
            fetch('http://localhost:3002/api/candidates')
                .then(response => response.json())
                .then(data => {
                    const candidatesList = document.getElementById('candidatesList');
                    
                    if (data.data.length === 0) {
                        candidatesList.innerHTML = '<p>No candidates found. Add candidates to get started.</p>';
                    } else {
                        candidatesList.innerHTML = data.data.map(candidate => `
                            <div class="candidate-card">
                                <div class="candidate-photo">
                                    ${candidate.photo_url ? 
                                        `<img src="${candidate.photo_url}" alt="${candidate.name}">` : 
                                        `<i class="fas fa-user-circle"></i>`}
                                </div>
                                <div class="candidate-info">
                                    <h3>${candidate.name}</h3>
                                    <p>Student ID: ${candidate.student_id}</p>
                                    <p>${candidate.details || 'No details provided'}</p>
                                </div>
                                <div class="candidate-actions">
                                    <button class="btn btn-primary btn-sm" onclick="editCandidate('${candidate.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCandidate('${candidate.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load candidates.');
                });
        }
        
        function loadElectionsForSelect() {
            fetch('http://localhost:3002/api/elections')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('candidateElection');
                    select.innerHTML = data.data.map(election => 
                        `<option value="${election.id}">${election.title}</option>`
                    ).join('');
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function saveElection() {
            const id = document.getElementById('electionId').value;
            const title = document.getElementById('electionTitle').value;
            const description = document.getElementById('electionDescription').value;
            const start_date = document.getElementById('electionStartDate').value;
            const end_date = document.getElementById('electionEndDate').value;
            const results_published = document.getElementById('resultsPublished') ? 
                document.getElementById('resultsPublished').checked : false;
            
            const url = id ? `http://localhost:3002/api/elections/${id}` : 'http://localhost:3002/api/elections';
            const method = id ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    start_date: start_date,
                    end_date: end_date,
                    results_published: results_published
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('electionModal').style.display = 'none';
                    loadElections();
                } else {
                    alert('Failed to save election.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the election.');
            });
        }
        
        // In dashboard.html, update the saveCandidate function
function saveCandidate() {
    const id = document.getElementById('candidateId').value;
    const election_id = document.getElementById('candidateElection').value;
    const name = document.getElementById('candidateName').value.trim();
    const student_id = document.getElementById('candidateStudentId').value.trim();
    const photo_url = document.getElementById('candidatePhotoUrl').value.trim();
    const details = document.getElementById('candidateDetails').value.trim();

    // Validate required fields
    if (!name || !student_id || !election_id) {
        alert('Name, Student ID, and Election are required fields');
        return;
    }

    const url = id ? `http://localhost:3002/api/candidates/${id}` : 'http://localhost:3002/api/candidates';
    const method = id ? 'PUT' : 'POST';

    // Show loading state
    const submitBtn = document.querySelector('#candidateForm button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            election_id: election_id,
            name: name,
            student_id: student_id,
            photo_url: photo_url || null,
            details: details || null
        })
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            // Handle student not found error specifically
            if (data.message && data.message.includes('does not exist')) {
                if (confirm(`${data.message}\nWould you like to register this student now?`)) {
                    window.open(`../student/register.html?student_id=${data.student_id}`, '_blank');
                }
            }
            throw new Error(data.message || 'Failed to save candidate');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            let successMsg = 'Candidate saved successfully';
            if (data.student_name) {
                successMsg += ` for student: ${data.student_name}`;
            }
            alert(successMsg);
            document.getElementById('candidateModal').style.display = 'none';
            loadCandidates();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'An error occurred while saving the candidate.');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
}
        
        function editElection(id) {
            fetch(`http://localhost:3002/api/elections/${id}`)
                .then(response => response.json())
                .then(data => {
                    const election = data.data;
                    document.getElementById('modalElectionTitle').textContent = 'Edit Election';
                    document.getElementById('electionId').value = election.id;
                    document.getElementById('electionTitle').value = election.title;
                    document.getElementById('electionDescription').value = election.description || '';
                    
                    // Format dates for datetime-local input
                    const startDate = new Date(election.start_date);
                    const endDate = new Date(election.end_date);
                    
                    document.getElementById('electionStartDate').value = 
                        startDate.toISOString().slice(0, 16);
                    document.getElementById('electionEndDate').value = 
                        endDate.toISOString().slice(0, 16);
                    
                    // Show results published checkbox for ended elections
                    if (new Date(election.end_date) < new Date()) {
                        document.getElementById('resultsPublishedContainer').style.display = 'block';
                        document.getElementById('resultsPublished').checked = election.results_published;
                    } else {
                        document.getElementById('resultsPublishedContainer').style.display = 'none';
                    }
                    
                    document.getElementById('electionModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load election details.');
                });
        }
        
        function editCandidate(id) {
            fetch(`http://localhost:3002/api/candidates/${id}`)
                .then(response => response.json())
                .then(data => {
                    const candidate = data.data[0];
                    document.getElementById('candidateId').value = candidate.id;
                    loadElectionsForSelect().then(() => {
                        document.getElementById('candidateElection').value = candidate.election_id;
                    });
                    document.getElementById('candidateName').value = candidate.name;
                    document.getElementById('candidateStudentId').value = candidate.student_id;
                    document.getElementById('candidatePhotoUrl').value = candidate.photo_url || '';
                    document.getElementById('candidateDetails').value = candidate.details || '';
                    
                    document.getElementById('candidateModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load candidate details.');
                });
        }
        
        function deleteElection(id) {
            if (confirm('Are you sure you want to delete this election? This will also delete all associated candidates and votes.')) {
                fetch(`http://localhost:3002/api/elections/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadElections();
                        loadCandidates();
                    } else {
                        alert('Failed to delete election.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the election.');
                });
            }
        }
        
        function deleteCandidate(id) {
            if (confirm('Are you sure you want to delete this candidate?')) {
                fetch(`http://localhost:3002/api/candidates/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadCandidates();
                    } else {
                        alert('Failed to delete candidate.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the candidate.');
                });
            }
        }
        
        function publishResults(electionId) {
            if (confirm('Are you sure you want to publish the results for this election? This cannot be undone.')) {
                fetch(`http://localhost:3002/api/elections/${electionId}/publish-results`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Results published successfully');
                        loadElections();
                    } else {
                        alert('Failed to publish results.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while publishing results.');
                });
            }
        }
        
        function logout() {
            fetch('http://localhost:3002/api/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('userRole');
                    window.location.href = '../index.html';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>